<ion-content [fullscreen]="true">
  <!-- <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)" mode="ios">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      refreshingSpinner="circles"
      refreshingText="Refrescando" >
    </ion-refresher-content>
  </ion-refresher>   -->
  <div class="map-container" id="open-modal">
    <div #mapContainer class="map"></div>
  </div>
  <ion-modal 
    #modal
    trigger="open-modal"
    [isOpen]="isModalOpen"
    [initialBreakpoint]="0.2"
    [backdropDismiss]="false"
    [backdropBreakpoint]="0.5"
    [breakpoints]="[0, 0.1, 0.4, 0.5, 0.98]">
    <ng-template>
      <ion-content [scrollEvents]="true" class="ion-padding">
        <button class="absolute top-2 right-0 w-12 text-gray-700 z-50" (click)="dismiss()">
          <ion-icon class="bg-gray-50 text-gray-700 rounded-full text-xl" slot="icon-only" name="close"></ion-icon>
        </button>

        <!-- Mostrar botón de retroceso si se están viendo los detalles -->
        <ng-container *ngIf="isShowingDetails; else originalData">
          <button class="absolute top-2 left-0 w-12 text-gray-700 z-50" (click)="goBackToList()">
            <ion-icon class="bg-gray-50 text-gray-700 rounded-full text-xl" slot="icon-only" name="arrow-back"></ion-icon>
          </button>

          <!-- Vista de detalles de la veterinaria -->
          <div *ngIf="selectedPlace">
            <ion-img [src]="selectedPlace.Img" alt="Imagen de Veterinaria"></ion-img>
            <h1>{{ selectedPlace.Nombre }}</h1>
            <p>{{ selectedPlace.Descripcion }}</p>
            <p><strong>Dirección:</strong> {{ selectedPlace.Direccion }}</p>
            <p><strong>Sitio Web:</strong> <a [href]="selectedPlace.Web">{{ selectedPlace.Web }}</a></p>
          </div>
        </ng-container>

        <!-- Plantilla de la lista original agrupada por categorías -->
        <ng-template #originalData>
          <ng-container *ngIf="!isLoading; else skeletonTemplate">
            <ng-container *ngIf="getObjectKeys(placeGroupedByCategoria).length; else noDataTemplate">
              <ng-container *ngFor="let categoria of getObjectKeys(placeGroupedByCategoria)">
                <h1 class="pb-2 text-2xl font-medium">{{ categoria }}</h1>
                <span class="bg-blue-400 mx-auto mb-4 inline-block h-1 w-[90px] rounded"></span>
                <swiper-container [slidesPerView]="1.3" [loop]="false">
                  <swiper-slide *ngFor="let veterinaria of placeGroupedByCategoria[categoria]">
                    <ng-container>
                      <div class="px-3" (click)="goToVeterinariaDetails(veterinaria)">
                        <div class="w-full bg-white rounded-3xl flex flex-col items-start justify-between gap-3 border border-gray-100">
                          <div class="w-full">
                            <div class="w-full h-52 rounded-tl-2xl rounded-tr-2xl overflow-hidden relative">
                              <ion-img class="w-full h-full object-cover object-center" [src]="veterinaria.Img" alt="Imagen de Veterinaria"></ion-img>
                              <div class="absolute bottom-2 left-3">
                                <span
                                  class="text-xs font-medium me-2 px-2.5 py-0.5 rounded-full text-white"
                                  [ngClass]="{
                                    'bg-blue-700': veterinaria.Categoria === 'Veterinarias Movil',
                                    'bg-yellow-700': veterinaria.Categoria === 'Clinicas',
                                    'bg-green-700': veterinaria.Categoria === 'PetShops',
                                    'bg-red-700': veterinaria.Categoria === 'Peluquerias',
                                    'bg-blue-400': veterinaria.Categoria === 'Veterinarias'
                                  }"
                                >
                                  {{ veterinaria.Categoria }}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="my-4 px-2">
                          <div class="text-center">
                            <p class="text-black font-medium text-lg mb-1">{{ veterinaria.Nombre }}</p>
                            <span class="bg-blue-400 mx-auto mb-4 inline-block h-1 w-[90px] rounded"></span>
                            <p class="text-gray-500">{{ veterinaria.Descripcion }}</p>
                          </div>
                          <div class="flex gap-3 justify-center mt-4 flex-wrap">
                            <button class="text-gray-600 col-span-1 flex justify-center items-center rounded-lg p-2 duration-300 bg-slate-100 hover:shadow-md hover:text-blue-400">
                              <ion-icon name="logo-whatsapp"></ion-icon>
                            </button>
                            <button class="text-gray-600 col-span-1 flex justify-center items-center rounded-lg p-2 duration-300 bg-slate-100 hover:shadow-md hover:text-blue-400">
                              <ion-icon name="logo-instagram"></ion-icon>
                            </button>
                            <button class="text-gray-600 col-span-1 flex justify-center items-center rounded-lg p-2 duration-300 bg-slate-100 hover:shadow-md hover:text-blue-400">
                              <ion-icon name="globe"></ion-icon>
                            </button>
                            <button class="text-gray-600 col-span-1 flex justify-center items-center rounded-lg p-2 duration-300 bg-slate-100 hover:shadow-md hover:text-blue-400">
                              <ion-icon name="logo-facebook"></ion-icon>
                            </button>
                          </div>
                        </div>
                      </div>
                    </ng-container>
                  </swiper-slide>
                </swiper-container>
              </ng-container>
            </ng-container>
          </ng-container>
          <ng-template #skeletonTemplate>
            <ng-container>
              <swiper-container [slidesPerView]="1.3" [loop]="false" [scrollbar]="true" *ngFor="let item of skeletonMap">
                <swiper-slide>
                  <ion-skeleton-text animated style="width: 50%; height: 24px;"></ion-skeleton-text>
                  <span class="bg-blue-400 mx-auto mb-4 inline-block h-1 w-[90px] rounded"></span>
                  <div class="w-full bg-white rounded-3xl flex flex-col items-start justify-between gap-3 border-gray-200">
                    <div class="w-full">
                      <ion-skeleton-text animated style="width: 100%; height: 208px;"></ion-skeleton-text>
                      <div class="my-4 px-2">
                        <ion-skeleton-text animated style="width: 70%; height: 18px;"></ion-skeleton-text>
                        <span class="bg-blue-400 mx-auto mb-4 inline-block h-1 w-[90px] rounded"></span>
                        <ion-skeleton-text animated style="width: 90%; height: 14px;"></ion-skeleton-text>
                        <div class="flex gap-3 justify-center mt-4 flex-wrap">
                          <ion-skeleton-text animated style="width: 24px; height: 24px; border-radius: 50%;"></ion-skeleton-text>
                          <ion-skeleton-text animated style="width: 24px; height: 24px; border-radius: 50%;"></ion-skeleton-text>
                          <ion-skeleton-text animated style="width: 24px; height: 24px; border-radius: 50%;"></ion-skeleton-text>
                          <ion-skeleton-text animated style="width: 24px; height: 24px; border-radius: 50%;"></ion-skeleton-text>
                        </div>
                      </div>
                    </div>
                  </div>
                </swiper-slide>
              </swiper-container>
            </ng-container>
          </ng-template>         
          <ng-template #noDataTemplate>
            <div class="text-center py-8">
              <p class="text-lg font-medium text-gray-600">No hay lugares disponibles.</p>
            </div>
          </ng-template>
        </ng-template>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
